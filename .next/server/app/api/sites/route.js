"use strict";(()=>{var e={};e.id=865,e.ids=[865],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5213:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>w,patchFetch:()=>x,requestAsyncStorage:()=>g,routeModule:()=>h,serverHooks:()=>f,staticGenerationAsyncStorage:()=>P});var r={};a.r(r),a.d(r,{GET:()=>d,dynamic:()=>c,runtime:()=>u});var s=a(9303),n=a(8716),o=a(3131),i=a(7070);let u="nodejs",c="force-dynamic",l=e=>e*Math.PI/180,m=e=>111.32*Math.cos(l(e));function p(e){let t=e?.AddressInfo||{},a=Array.isArray(e?.Connections)?e.Connections:[],r=a.reduce((e,t)=>{let a=Number(t?.PowerKW??0);return isFinite(a)?Math.max(e,a):e},0);return{id:e?.ID??null,lat:t?.Latitude??null,lon:t?.Longitude??null,name:t?.Title??"EV charge point",addr:[t?.AddressLine1,t?.Town,t?.Postcode].filter(Boolean).join(", "),postcode:t?.Postcode??null,status:e?.StatusType?.IsOperational===!1?"down":"up",connectors:a.length,maxPowerKw:r,source:"ocm"}}async function d(e){let t=new URL(e.url),a=t.searchParams.get("bbox"),r=t.searchParams.get("source"),s=t.searchParams.get("conn"),n=t.searchParams.get("minPower"),o=t.searchParams.get("radiusKm"),u=t.searchParams.get("debug"),{raw:c,useOCM:l}=function(e){let t=(e||"").toLowerCase().trim();return{raw:t,useOCM:""===t||"ocm"===t||"openchargemap"===t||"open charge map"===t||"open-charge-map"===t||"opencharge"===t||"open-charge"===t||"all"===t||"*"===t,useCouncil:"council"===t||"all"===t||"*"===t}}(r),d=null,h=null,g=4.5;if(a){let e=String(a).split(",").map(e=>Number(e.trim()));if(4===e.length&&e.every(Number.isFinite)){let[t,a,r,s]=e,n=function(e,t,a,r){let s=(t+r)/2,n=.5*Math.abs(a-e)*m(s);return{latC:s,lonC:(e+a)/2,radiusKm:Math.max(.5*Math.abs(r-t)*111.32,n)}}(t,a,r,s);d=n.latC,h=n.lonC,g=function(e,t){let a=e?Number(e):NaN;return!isFinite(a)||a<=0?t:Math.max(a,t)}(o,Math.max(4.5,n.radiusKm))}}(null==d||null==h)&&(d=51.5074,h=-.1278);let P=function(){let e=process.env.OCM_API_KEY||process.env.OPENCHARGEMAP_API_KEY;return e&&e.trim()?e.trim():void 0}(),f={"User-Agent":"Autodun/1.0",Accept:"application/json"};P&&(f["X-API-Key"]=P);let w=(e,t,a)=>{let r=new URL("https://api.openchargemap.io/v3/poi/");return r.searchParams.set("output","json"),r.searchParams.set("compact","true"),r.searchParams.set("verbose","false"),r.searchParams.set("maxresults","1000"),r.searchParams.set("latitude",String(e)),r.searchParams.set("longitude",String(t)),r.searchParams.set("distance",String(a)),r.searchParams.set("distanceunit","KM"),P&&r.searchParams.set("key",P),s&&r.searchParams.set("connectiontypeid",s),n&&r.searchParams.set("minpowerkw",n),r},x=null,A=0,v=async e=>{x=e.toString();let t=await fetch(x,{headers:f,cache:"no-store"});if(A=t.status,!t.ok){let e=await t.text().catch(()=>"");throw Error(`OCM ${t.status}: ${e?.slice(0,300)}`)}let a=await t.json();return(Array.isArray(a)?a:[]).map(p).filter(e=>null!=e.lat&&null!=e.lon)};try{let e=[];l&&(e=await v(w(d,h,g)),0===e.length&&(e=await v(w(d,h,Math.max(g,8)))));let t={sites:e};return"1"===u&&(t.debug={count:e.length,authed:!!P,ocmStatus:A,ocmUrlUsed:x,sourceParam:c,center:{latC:d,lonC:h,radiusTriedKm:g},sample:e.slice(0,3)}),i.NextResponse.json(t,{headers:{"Cache-Control":"no-store"}})}catch(e){return i.NextResponse.json({error:"Sites fetch failed",message:String(e)},{status:502})}}let h=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/sites/route",pathname:"/api/sites",filename:"route",bundlePath:"app/api/sites/route"},resolvedPagePath:"/workspaces/autodun-ev-finder/app/api/sites/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:P,serverHooks:f}=h,w="/api/sites/route";function x(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:P})}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[948,972],()=>a(5213));module.exports=r})();