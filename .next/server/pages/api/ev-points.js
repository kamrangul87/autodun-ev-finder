"use strict";(()=>{var e={};e.id=291,e.ids=[291],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,n){return n in t?t[n]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,n)):"function"==typeof t&&"default"===n?t:void 0}}})},7335:(e,t,n)=>{n.r(t),n.d(t,{config:()=>p,default:()=>f,routeModule:()=>m});var r={};n.r(r),n.d(r,{default:()=>c});var o=n(1802),a=n(7153),s=n(6249);let l={32:"CCS",33:"CCS",2:"CHAdeMO",28:"Type 2",30:"Type 2",25:"Tesla",27:"Tesla",1036:"Tesla",1030:"CCS",1031:"CCS"},i=new Map;function u(e,t=2){let n=10**t;return Math.round(e*n)/n}async function d(e,t={},n=1){let r=t.timeout??8e3,o=new AbortController,a=setTimeout(()=>o.abort(),r);try{let r=await fetch(e,{...t,signal:o.signal});if(!r.ok&&r.status>=500&&r.status<600&&n<3)return await new Promise(e=>setTimeout(e,300*n)),d(e,t,n+1);return r}catch(r){if(n<3)return await new Promise(e=>setTimeout(e,300*n)),d(e,t,n+1);throw r}finally{clearTimeout(a)}}async function c(e,t){let n=Number(e.query.lat??52.5),r=Number(e.query.lon??-1.5),o=Number(e.query.distKm??400),a=`GB:${u(n,2)}:${u(r,2)}:${Math.round(o/50)}`,s=Date.now(),c=i.get(a);if(c&&s-c.ts<6e5)return t.setHeader("Cache-Control","s-maxage=1200, stale-while-revalidate=600"),t.status(200).json(c.data);let f=`https://api.openchargemap.io/v3/poi/?output=json&countrycode=GB&latitude=${n}&longitude=${r}&distance=${o}&distanceunit=KM&maxresults=5000&compact=true&verbose=false`,p={};process.env.OCM_API_KEY&&(p["X-API-Key"]=process.env.OCM_API_KEY);try{let e=await d(f,{headers:p,cache:"no-store",timeout:8e3});if(!e.ok)throw Error(`OCM ${e.status}`);let n=(await e.json()).map(e=>{let t=e.AddressInfo?.Latitude,n=e.AddressInfo?.Longitude;if("number"!=typeof t||"number"!=typeof n)return null;let r=[e.AddressInfo?.AddressLine1,e.AddressInfo?.Town,e.AddressInfo?.StateOrProvince].filter(Boolean).join(", ")||e.AddressInfo?.Title||null,o=e.AddressInfo?.Postcode??null,a=e.Connections??[],s=new Set,i=0,u=!1;for(let e of a){let t=function(e){let t=e?.ConnectionTypeID??null;if(t&&l[t])return l[t];let n=[e?.ConnectionType?.Title,e?.ConnectionType?.FormalName,e?.Level?.Title,e?.CurrentType?.Title].filter(Boolean).join(" ").toLowerCase();return n?n.includes("ccs")||n.includes("combo")||n.includes("type 2 combo")||n.includes("iec 62196-3")?"CCS":n.includes("chademo")?"CHAdeMO":n.includes("type 2")||n.includes("mennekes")||n.includes("iec 62196-2")||n.includes("t2")?"Type 2":n.includes("tesla")||n.includes("supercharger")||n.includes("nacs")?"Tesla":null:null}(e);t&&s.add(t);let n=Number(e?.PowerKW??0);n>i&&(i=n);let r=(e?.Level?.Title||"").toLowerCase(),o=(e?.CurrentType?.Title||"").toLowerCase();(e?.LevelID===3||r.includes("dc")||r.includes("rapid")||o.includes("dc"))&&(u=!0)}let d=(a?.length??e.NumberOfPoints??0)||0,c=e.StatusType?.IsOperational===!0?1:.6;return{id:e.ID??null,name:e.AddressInfo?.Title??null,addr:r,postcode:o,lat:t,lng:n,value:Math.max(.01,Math.log1p(d)*c),breakdown:{reports:0,downtime:0,connectors:Math.max(.1,d)},op:e.OperatorInfo?.Title??null,dc:u,kw:i||null,conn:d,types:Array.from(s)}}).filter(Boolean);return i.set(a,{ts:s,data:n}),t.setHeader("Cache-Control","s-maxage=1200, stale-while-revalidate=600"),t.status(200).json(n)}catch(n){let e=i.get(a);if(e)return t.setHeader("Cache-Control","s-maxage=60"),t.status(200).json(e.data);return t.status(500).json({error:n?.message??"Failed to fetch OCM"})}}let f=(0,s.l)(r,"default"),p=(0,s.l)(r,"config"),m=new o.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/ev-points",pathname:"/api/ev-points",bundlePath:"",filename:""},userland:r})},7153:(e,t)=>{var n;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return n}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(n||(n={}))},1802:(e,t,n)=>{e.exports=n(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var n=t(t.s=7335);module.exports=n})();