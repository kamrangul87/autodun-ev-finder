1) Search/geocode goes outside the UK (e.g., “london” → Indian Ocean)

Goal: Always bias/lock searches to the United Kingdom and keep the map inside UK bounds.

Implement

Update the geocoding function to call Nominatim with:

countrycodes=gb

limit=1

bounded=1

viewbox covering UK (-8.649, 60.845, 1.763, 49.823)

Always fallback to a UK result; if no UK match, show a small “Not found in UK” toast and do not move the map.

When q= is present on first load: geocode once (with the UK bias above), then fitBounds to the result’s bounding box, then fetch stations with that bbox (don’t fetch before the bounds are set).

Add a hard guard: after any geocode, if lat/lng OR bounds are outside UK, clamp to UK bounds and retry fetch.

Update banner: Source: OPENCHARGE (live) • Stations: {count} • Bounds: {UK|Region|City}.

2) Popup/feedback sheet closes instantly (clicks pass through map)

Goal: Popups and the feedback form are stable and don’t close unless the user clicks a close/X or presses ESC.

Implement

For Leaflet popups and the custom feedback bottom sheet:

Set closeOnClick: false and autoClose: false on marker popups.

While the feedback sheet is open: disable map interactions (dragging/scrollWheelZoom/boxZoom off) and re-enable on close.

Stop event propagation on all interactive elements inside the sheet and popup (click, mousedown, touchstart).

When the sheet opens on mobile, apply a scrim overlay (pointer-events: auto on the sheet, none on the map behind).

Ensure the Directions/Feedback buttons don’t blur/focus the map (prevent default + stopPropagation).

3) First render shows tiny counts (e.g., “2”) until zoom

Goal: Nationwide stations & heatmap visible immediately; counts match fetch size.

Implement

First render: fit UK bounds, then fetch /api/stations?bbox=<UK>&tiles=4&limitPerTile=500 and render clusters + heatmap from this dataset.

Do not show a single “1000” blob in the middle — ensure the cluster layer receives the full merged feature set on first render. Reuse the same cluster group instance and just update data.

On moveend (debounced ~400ms): refetch with current bounds and update layers.

Heatmap: when visible count > ~25k, downsample (e.g., every 3rd point) to keep 60fps.

4) Council layer polish

Goal: Council diamonds + dashed boundaries, stable popup with quick stats.

Implement

Purple diamond markers at centroids; click shows popup with council name + “Stations in boundary: N” (compute with turf point-in-polygon against currently fetched points; if >10k, sample to 5k to keep fast).

Button actions (Feedback, Directions to centroid) obey the same popup/stability rules above.

✅ QA CHECKLIST (must pass before publishing)

Search lock to UK

Type: london, manchester, aberdeen, belfast, cardiff

Map centers correctly inside the UK every time. No jumps offshore.

If term not in UK (e.g., “paris”), show toast “Place not found in the UK” and do not move the map.

First render

At app open (no q=), you see cluster numbers across the whole of UK and a heatmap.

Banner shows OPENCHARGE (live) • Stations: {large number} • Bounds: United Kingdom.

Pan & zoom

Pan to Scotland/NI → after stop, clusters + heatmap repopulate there within ~1–2s. No stall.

Popups & feedback

Click any station: popup stays open until closed.

Open feedback: map cannot be dragged; sheet stays; submit works; closing re-enables map.

Mobile (iPhone/Android): bottom sheet feels native, no flicker.

Council

Toggle on: purple diamonds + dashed borders.

Click a council marker: popup shows name + computed station count; Directions opens maps.

Network

DevTools → Network: /api/stations?...bbox=...&tiles=... requests; source: OPENCHARGE in payload; no demo.

Response sizes look consistent with viewport area (bigger area → more features).

Vercel parity

Same behavior on Preview & Production. No “STATIC • 20” regressions.

Please attach 3 screenshots with console open:

First render (UK-wide clusters + heatmap)

Search “london” centered correctly, banner shows “Bounds: Greater London” (or similar)

Council popup with “Stations in boundary: N”

Then publish.